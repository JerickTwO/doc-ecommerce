---
import { Fragment } from "astro/jsx-runtime";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login de Cliente</title>
  </head>

  <body
    class="min-h-screen bg-gray-50 flex items-center justify-center font-sans"
  >
    <main class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
      <header class="text-center mb-6">
        <h1 class="text-2xl font-bold text-indigo-700">Área de Clientes</h1>
        <p class="text-sm text-gray-500">Accede con tu RUC</p>
      </header>

      <!-- Mensaje de feedback -->
      <p
        id="mensaje"
        class="mb-4 text-center text-sm font-medium transition-opacity duration-200 opacity-0"
      >
      </p>

      <!-- Formulario -->
      <form id="login-form" class="space-y-4">
        <label class="block">
          <span class="text-gray-700 text-sm font-medium">RUC</span>
          <input
            id="ruc"
            name="ruc"
            type="text"
            maxlength="20"
            required
            class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="Ingrese su RUC"
          />
        </label>

        <button
          id="submit-btn"
          type="submit"
          class="w-full flex justify-center items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 font-semibold text-white transition-colors hover:bg-indigo-700 disabled:opacity-50 disabled:pointer-events-none"
        >
          <span>Ingresar</span>
          <!-- Spinner SVG (esconde/mostrar con JS) -->
          <svg
            id="spinner"
            class="h-5 w-5 animate-spin hidden"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8v4l3.5-3.5L12 0v4a8 8 0 00-8 8h4z"></path>
          </svg>
        </button>
      </form>
    </main>

    <!-- Script inline (is:inline para SSR) -->
    <script is:inline type="module">
      const form = document.getElementById("login-form");
      const mensajeEl = document.getElementById("mensaje");
      const btn = document.getElementById("submit-btn");
      const spinner = document.getElementById("spinner");

      const mostrarMensaje = (texto, tipo = "error") => {
        mensajeEl.textContent = texto;
        mensajeEl.classList.remove(
          "opacity-0",
          "text-red-500",
          "text-green-600"
        );
        mensajeEl.classList.add(
          "opacity-100",
          tipo === "success" ? "text-green-600" : "text-red-500"
        );
      };

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const ruc = form.ruc.value.trim();
        if (!ruc) return mostrarMensaje("Ingrese su RUC");

        // UI: bloquea botón y muestra spinner
        btn.disabled = true;
        spinner.classList.remove("hidden");

        try {
          const res = await fetch("/api/auth/login-cliente", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ruc }),
          });
          const data = await res.json();

          if (res.ok && data.success) {
            mostrarMensaje(`Bienvenido, ${data.user.razon_social}`, "success");

            setTimeout(() => {
              window.location.href = `/proyectos-clientes-detalles`;
            }, 100);
          } else {
            mostrarMensaje(data.message || "RUC no encontrado");
          }
        } catch (err) {
          console.error(err);
          mostrarMensaje("No se pudo contactar al servidor");
        } finally {
          btn.disabled = false;
          spinner.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
